<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios Estat√≠sticos - Sistema de Arquivo</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #f8f9fa;
            color: #2c3e50;
        }

        .header {
            background: white;
            border-bottom: 1px solid #e1e4e8;
            padding: 24px;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 24px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .back-btn {
            background: white;
            color: #0366d6;
            border: 1px solid #e1e4e8;
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            text-decoration: none;
            transition: all 0.2s;
        }

        .back-btn:hover {
            background: #f6f8fa;
            border-color: #0366d6;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 32px 24px;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .summary-card {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            padding: 24px;
            transition: all 0.2s;
        }

        .summary-card:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
        }

        .summary-label {
            font-size: 13px;
            color: #6c757d;
            margin-bottom: 8px;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .summary-value {
            font-size: 32px;
            font-weight: 600;
            color: #1a1a1a;
        }

        .summary-subtitle {
            font-size: 13px;
            color: #6c757d;
            margin-top: 4px;
        }

        .section {
            background: white;
            border: 1px solid #e1e4e8;
            border-radius: 12px;
            padding: 28px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 18px;
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-container {
            width: 100%;
            height: 400px;
            margin-bottom: 20px;
        }

        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }

        thead {
            background: #f8f9fa;
        }

        th {
            text-align: left;
            padding: 12px 16px;
            font-weight: 600;
            color: #1a1a1a;
            border-bottom: 2px solid #e1e4e8;
        }

        td {
            padding: 12px 16px;
            border-bottom: 1px solid #e1e4e8;
            color: #2c3e50;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .insight-box {
            background: #e7f5ff;
            border-left: 4px solid #0366d6;
            padding: 16px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .insight-title {
            font-weight: 600;
            color: #1a1a1a;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .insight-text {
            color: #2c3e50;
            line-height: 1.6;
            font-size: 14px;
        }

        .loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 400px;
        }

        .spinner {
            border: 4px solid #f1f3f5;
            border-top: 4px solid #0366d6;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: #d4edda;
            color: #155724;
        }

        .badge-warning {
            background: #fff3cd;
            color: #856404;
        }

        .badge-info {
            background: #d1ecf1;
            color: #0c5460;
        }

        @media print {
            .header, .back-btn {
                display: none;
            }
            .section {
                page-break-inside: avoid;
            }
        }

        @media (max-width: 768px) {
            .summary-grid {
                grid-template-columns: 1fr;
            }
            .chart-container {
                height: 300px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>üìä Relat√≥rios Estat√≠sticos</h1>
            <a href="/" class="back-btn">‚Üê Voltar ao Hub</a>
        </div>
    </div>

    <div id="loading" class="loading">
        <div class="spinner"></div>
        <p>Gerando relat√≥rios e an√°lises...</p>
    </div>

    <div class="container" id="content" style="display: none;">
        <!-- Resumo Executivo -->
        <div class="summary-grid" id="summaryGrid"></div>

        <!-- Insights Autom√°ticos -->
        <div class="section">
            <div class="section-title">üí° Insights Principais</div>
            <div id="insightsContainer"></div>
        </div>

        <!-- Gr√°fico de Distribui√ß√£o -->
        <div class="section">
            <div class="section-title">üìà Distribui√ß√£o por Situa√ß√£o</div>
            <div id="chartDistribuicao" class="chart-container"></div>
        </div>

        <!-- Gr√°fico de Tend√™ncias -->
        <div class="section">
            <div class="section-title">üìä Ocupa√ß√£o de Boxes</div>
            <div id="chartOcupacao" class="chart-container"></div>
        </div>

        <!-- Tabela de Frequ√™ncias -->
        <div class="section">
            <div class="section-title">üìã Tabela de Frequ√™ncias</div>
            <div class="table-container" id="tabelaFrequencias"></div>
        </div>

        <!-- An√°lise Detalhada -->
        <div class="section">
            <div class="section-title">üîç An√°lise Detalhada por Situa√ß√£o</div>
            <div class="table-container" id="tabelaDetalhada"></div>
        </div>
    </div>

    <script>
        console.log('=== Iniciando p√°gina de relat√≥rios ===');
        
        const dataStr = sessionStorage.getItem('relatoriosData');
        console.log('Dados do sessionStorage:', dataStr ? 'Encontrados' : 'N√ÉO encontrados');
        
        if (!dataStr) {
            console.error('Nenhum dado encontrado no sessionStorage');
            alert('Nenhum dado encontrado. Voc√™ precisa fazer upload de um arquivo primeiro. Redirecionando...');
            window.location.href = '/';
            throw new Error('Sem dados');
        }

        let data;
        try {
            data = JSON.parse(dataStr);
            console.log('Dados parseados com sucesso:', {
                total_geral: data.total_geral,
                boxes_ocupados: data.boxes_ocupados,
                situacoes: data.colunas_situacoes?.length || 0
            });
        } catch (e) {
            console.error('Erro ao fazer parse dos dados:', e);
            alert('Erro ao carregar dados. Redirecionando...');
            window.location.href = '/';
            throw e;
        }

        // Verificar se os dados essenciais est√£o completos
        if (data.total_geral === undefined || data.boxes_ocupados === undefined || !data.colunas_situacoes) {
            console.error('Dados incompletos:', data);
            alert('Dados incompletos ou corrompidos. Fa√ßa upload novamente.');
            window.location.href = '/';
            throw new Error('Dados incompletos');
        }
        
        console.log('Valida√ß√£o OK! Dados completos.');

        // Ocultar loading
        document.getElementById('loading').style.display = 'none';
        document.getElementById('content').style.display = 'block';
        
        console.log('P√°gina carregada, iniciando renderiza√ß√£o...');

        // ==== RESUMO EXECUTIVO ====
        const summaryGrid = document.getElementById('summaryGrid');
        
        const summaryCards = [
            { label: 'Total de Documentos', value: data.total_geral.toLocaleString('pt-BR'), subtitle: 'em todo o arquivo' },
            { label: 'Boxes Ocupados', value: data.boxes_ocupados.toLocaleString('pt-BR'), subtitle: `de ${data.total_boxes} registrados` },
            { label: 'Boxes Vazios', value: (7000 - data.boxes_ocupados).toLocaleString('pt-BR'), subtitle: 'dispon√≠veis' },
            { label: 'Taxa de Ocupa√ß√£o', value: ((data.boxes_ocupados / 7000) * 100).toFixed(1) + '%', subtitle: 'do arquivo' },
            { label: 'Situa√ß√µes Diferentes', value: data.colunas_situacoes.length, subtitle: 'tipos de status' },
            { label: 'M√©dia por Box', value: (data.total_geral / data.boxes_ocupados).toFixed(0), subtitle: 'documentos/box' }
        ];

        summaryCards.forEach(card => {
            const div = document.createElement('div');
            div.className = 'summary-card';
            div.innerHTML = `
                <div class="summary-label">${card.label}</div>
                <div class="summary-value">${card.value}</div>
                <div class="summary-subtitle">${card.subtitle}</div>
            `;
            summaryGrid.appendChild(div);
        });

        // ==== INSIGHTS AUTOM√ÅTICOS ====
        const insightsContainer = document.getElementById('insightsContainer');
        
        // Encontrar situa√ß√£o predominante
        const situacaoPredominante = Object.entries(data.totais_por_situacao)
            .sort((a, b) => b[1] - a[1])[0];
        
        const percentPredominante = ((situacaoPredominante[1] / data.total_geral) * 100).toFixed(1);
        
        // Calcular capacidade restante
        const capacidadeRestante = 7000 - data.boxes_ocupados;
        const percentCapacidade = ((capacidadeRestante / 7000) * 100).toFixed(1);

        const insights = [
            {
                title: 'üìå Situa√ß√£o Predominante',
                text: `A situa√ß√£o "${situacaoPredominante[0]}" representa ${percentPredominante}% do total de documentos (${situacaoPredominante[1].toLocaleString('pt-BR')} documentos), sendo a categoria mais significativa do arquivo.`
            },
            {
                title: 'üì¶ Capacidade do Arquivo',
                text: `O arquivo possui ${capacidadeRestante.toLocaleString('pt-BR')} boxes vazios (${percentCapacidade}% da capacidade total), indicando ${percentCapacidade > 30 ? 'boa disponibilidade' : 'capacidade limitada'} para expans√£o.`
            },
            {
                title: 'üìä Densidade M√©dia',
                text: `Cada box ocupado cont√©m em m√©dia ${(data.total_geral / data.boxes_ocupados).toFixed(0)} documentos, ${(data.total_geral / data.boxes_ocupados) > 30 ? 'sugerindo boa utiliza√ß√£o do espa√ßo' : 'indicando potencial para otimiza√ß√£o'}.`
            }
        ];

        insights.forEach(insight => {
            const div = document.createElement('div');
            div.className = 'insight-box';
            div.innerHTML = `
                <div class="insight-title">${insight.title}</div>
                <div class="insight-text">${insight.text}</div>
            `;
            insightsContainer.appendChild(div);
        });

        // ==== GR√ÅFICO DE DISTRIBUI√á√ÉO (Pizza) ====
        const distribuicaoData = [{
            values: Object.values(data.totais_por_situacao),
            labels: data.colunas_situacoes,
            type: 'pie',
            hole: 0.4,
            marker: {
                colors: Object.values(data.mapa_cores)
            },
            textinfo: 'label+percent',
            textposition: 'outside',
            automargin: true
        }];

        const distribuicaoLayout = {
            showlegend: true,
            legend: { orientation: 'v', x: 1.1, y: 0.5 },
            margin: { t: 20, b: 20, l: 20, r: 20 },
            font: { family: 'system-ui, -apple-system, sans-serif', size: 12 }
        };

        Plotly.newPlot('chartDistribuicao', distribuicaoData, distribuicaoLayout, {responsive: true});

        // ==== GR√ÅFICO DE OCUPA√á√ÉO (Barras) ====
        const situacoesOrdenadas = Object.entries(data.totais_por_situacao)
            .sort((a, b) => b[1] - a[1]);

        const ocupacaoData = [{
            x: situacoesOrdenadas.map(s => s[0]),
            y: situacoesOrdenadas.map(s => s[1]),
            type: 'bar',
            marker: {
                color: situacoesOrdenadas.map(s => data.mapa_cores[s[0]]),
                line: { color: '#e1e4e8', width: 1 }
            },
            text: situacoesOrdenadas.map(s => s[1].toLocaleString('pt-BR')),
            textposition: 'outside',
            hovertemplate: '<b>%{x}</b><br>%{y:,.0f} documentos<extra></extra>'
        }];

        const ocupacaoLayout = {
            xaxis: { title: '', tickangle: -45 },
            yaxis: { title: 'Quantidade de Documentos', separatethousands: true },
            margin: { t: 20, b: 100, l: 80, r: 20 },
            font: { family: 'system-ui, -apple-system, sans-serif', size: 12 },
            showlegend: false
        };

        Plotly.newPlot('chartOcupacao', ocupacaoData, ocupacaoLayout, {responsive: true});

        // ==== TABELA DE FREQU√äNCIAS ====
        const tabelaFrequencias = document.getElementById('tabelaFrequencias');
        
        let tableHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Situa√ß√£o</th>
                        <th>Quantidade</th>
                        <th>Percentual</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
        `;

        situacoesOrdenadas.forEach(([sit, count]) => {
            const percent = ((count / data.total_geral) * 100).toFixed(2);
            const badge = percent > 30 ? 'badge-success' : percent > 10 ? 'badge-info' : 'badge-warning';
            const status = percent > 30 ? 'Principal' : percent > 10 ? 'Relevante' : 'Menor';
            
            tableHTML += `
                <tr>
                    <td><strong>${sit}</strong></td>
                    <td>${count.toLocaleString('pt-BR')}</td>
                    <td>${percent}%</td>
                    <td><span class="badge ${badge}">${status}</span></td>
                </tr>
            `;
        });

        tableHTML += '</tbody></table>';
        tabelaFrequencias.innerHTML = tableHTML;

        // ==== TABELA DETALHADA ====
        const tabelaDetalhada = document.getElementById('tabelaDetalhada');
        
        let detailedHTML = `
            <table>
                <thead>
                    <tr>
                        <th>Status</th>
                        <th>Total Docs</th>
                        <th>% do Total</th>
                        <th>Boxes com este Status</th>
                        <th>M√©dia por Box</th>
                    </tr>
                </thead>
                <tbody>
        `;

        situacoesOrdenadas.forEach(([sit, count]) => {
            const percent = ((count / data.total_geral) * 100).toFixed(2);
            
            // Contar boxes que cont√™m este status
            let boxesComStatus = 0;
            if (data.status_por_box) {
                const boxesUnicos = new Set();
                data.status_por_box.forEach(item => {
                    if (item.Status === sit) {
                        boxesUnicos.add(item.Box);
                    }
                });
                boxesComStatus = boxesUnicos.size;
            } else {
                // Fallback: estimar
                boxesComStatus = Math.round((count / data.total_geral) * data.boxes_ocupados);
            }
            
            const mediaPorBox = boxesComStatus > 0 ? (count / boxesComStatus).toFixed(1) : 0;
            
            detailedHTML += `
                <tr>
                    <td><strong>${sit}</strong></td>
                    <td>${count.toLocaleString('pt-BR')}</td>
                    <td>${percent}%</td>
                    <td>${boxesComStatus.toLocaleString('pt-BR')}</td>
                    <td>${mediaPorBox}</td>
                </tr>
            `;
        });

        detailedHTML += '</tbody></table>';
        tabelaDetalhada.innerHTML = detailedHTML;
    </script>
</body>
</html>
