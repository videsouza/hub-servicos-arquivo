<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relatórios Estatísticos - Sistema de Arquivo</title>
    <script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
</head>
<body>

<div id="loading">Carregando relatórios...</div>
<div id="content" style="display:none;">

    <h2>Resumo Executivo</h2>
    <div id="summaryGrid"></div>

    <h2>Insights</h2>
    <div id="insightsContainer"></div>

    <h2>Distribuição por Situação</h2>
    <div id="chartDistribuicao"></div>

    <h2>Ocupação por Situação</h2>
    <div id="chartOcupacao"></div>

    <h2>Tabela de Frequências</h2>
    <div id="tabelaFrequencias"></div>

    <h2>Análise Detalhada</h2>
    <div id="tabelaDetalhada"></div>

</div>

<script>
// ==================== PROTEÇÃO ANTI-ERRO (BLINDADO) ====================
const dataStr = sessionStorage.getItem('relatoriosData');

if (!dataStr) {
    alert("Nenhum dado encontrado. Faça o upload novamente.");
    window.location.href = "/";
}

let data;

try {
    data = JSON.parse(dataStr);
} catch (e) {
    console.error("Erro ao converter JSON:", e);
    alert("Dados inválidos. Refaça o envio do arquivo.");
    window.location.href = "/";
}

if (!data || typeof data.total_geral === 'undefined') {
    console.error("Estrutura inválida:", data);
    alert("Os dados recebidos estão incompletos.");
    window.location.href = "/";
}

// ==================== VARIÁVEIS SEGURAS ====================
const totalGeral = data.total_geral ?? 0;
const boxesOcupados = data.boxes_ocupados ?? 0;
const totalBoxes = data.total_boxes ?? 0;
const colunasSituacoes = data.colunas_situacoes ?? [];
const totaisSituacao = data.totais_por_situacao ?? {};
const mapaCores = data.mapa_cores ?? {};
const boxesData = data.boxes_data ?? {};

// Exibir conteúdo
document.getElementById('loading').style.display = 'none';
document.getElementById('content').style.display = 'block';

// ==================== RESUMO ====================
const summaryGrid = document.getElementById('summaryGrid');

summaryGrid.innerHTML = `
    <p><strong>Total de Documentos:</strong> ${totalGeral.toLocaleString('pt-BR')}</p>
    <p><strong>Boxes Ocupados:</strong> ${boxesOcupados.toLocaleString('pt-BR')}</p>
    <p><strong>Taxa de Ocupação:</strong> ${boxesOcupados ? ((boxesOcupados / 7000) * 100).toFixed(1) : 0}%</p>
`;

// ==================== INSIGHTS ====================
const insightsContainer = document.getElementById('insightsContainer');

if (Object.keys(totaisSituacao).length > 0) {
    const situacaoPredominante = Object.entries(totaisSituacao).sort((a,b)=>b[1]-a[1])[0];
    const perc = ((situacaoPredominante[1] / totalGeral) * 100).toFixed(1);

    insightsContainer.innerHTML = `
        <p><strong>Situação predominante:</strong> ${situacaoPredominante[0]} (${perc}%)</p>
    `;
}

// ==================== GRÁFICO PIZZA ====================
if (Object.keys(totaisSituacao).length > 0) {
    Plotly.newPlot('chartDistribuicao', [{
        values: Object.values(totaisSituacao),
        labels: colunasSituacoes,
        type: 'pie',
        marker: { colors: Object.values(mapaCores) }
    }]);
}

// ==================== GRÁFICO BARRAS ====================
const situacoesOrdenadas = Object.entries(totaisSituacao).sort((a,b)=>b[1]-a[1]);

Plotly.newPlot('chartOcupacao', [{
    x: situacoesOrdenadas.map(s => s[0]),
    y: situacoesOrdenadas.map(s => s[1]),
    type: 'bar'
}]);

// ==================== TABELA FREQUÊNCIAS ====================
let tabelaFreq = '<table border="1"><tr><th>Situação</th><th>Total</th><th>%</th></tr>';

situacoesOrdenadas.forEach(([sit, total]) => {
    const percent = totalGeral ? ((total / totalGeral) * 100).toFixed(2) : 0;
    tabelaFreq += `<tr><td>${sit}</td><td>${total}</td><td>${percent}%</td></tr>`;
});

tabelaFreq += '</table>';
document.getElementById('tabelaFrequencias').innerHTML = tabelaFreq;

// ==================== ANÁLISE DETALHADA ====================
let tabelaDet = '<table border="1"><tr><th>Situação</th><th>Boxes</th><th>Média</th></tr>';

situacoesOrdenadas.forEach(([sit, total]) => {
    let boxesCom = 0;
    Object.values(boxesData).forEach(box => {
        if (box.situacoes && box.situacoes[sit]) boxesCom++;
    });

    const media = boxesCom ? (total / boxesCom).toFixed(1) : 0;
    tabelaDet += `<tr><td>${sit}</td><td>${boxesCom}</td><td>${media}</td></tr>`;
});

tabelaDet += '</table>';
document.getElementById('tabelaDetalhada').innerHTML = tabelaDet;

</script>

</body>
</html>
